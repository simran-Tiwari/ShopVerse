// // --------------------------
// // FIREBASE SECURITY RULES
// // --------------------------
// rules_version = '2';

// service cloud.firestore {
//   match /databases/{database}/documents {

//     // --------------------------
//     // USERS COLLECTION
//     // --------------------------
//     match /users/{userId} {
//       // A logged-in user can create their own user profile
//       allow create: if request.auth != null
//         && request.auth.uid == userId;

//       // User can read/update/delete their own account
//       allow read, update, delete: if request.auth != null
//         && request.auth.uid == userId;
//     }

//     // --------------------------
//     // VENDORS COLLECTION
//     // --------------------------
//     match /vendors/{vendorId} {
//       // Public read allowed (vendor profiles visible)
//       allow read: if true;

//       // Only the vendor themself can create/update/delete their vendor doc
//       allow create, update, delete: if request.auth != null
//         && request.auth.uid == vendorId
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor";
//     }

//     // --------------------------
//     // PRODUCTS COLLECTION
//     // --------------------------
//     match /products/{productId} {
//       // Anyone can read products
//       allow read: if true;

//       // Only authenticated vendors can create products
//       allow create: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor"
//         && request.resource.data.vendorId == request.auth.uid;

//       // Vendors can update/delete ONLY their own products
//       allow update, delete: if request.auth != null
//         && resource.data.vendorId == request.auth.uid;
//     }

//     // --------------------------
//     // SALES COLLECTION
//     // --------------------------
//     match /sales/{saleId} {
//       // Users can create sale history for themselves
//       allow create: if request.auth != null
//         && request.resource.data.userId == request.auth.uid;

//       // Reading a sale is allowed if:
//       // - Admin
//       // - Vendor related to the sale
//       // - Customer who made the purchase
//       allow read: if request.auth != null
//         && (
//             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
//             || resource.data.vendorId == request.auth.uid
//             || resource.data.userId == request.auth.uid
//         );

//       // Only the customer can update/delete their sale
//       allow update, delete: if request.auth != null
//         && resource.data.userId == request.auth.uid;
//     }

//     // --------------------------
//     // ADMIN COLLECTIONS
//     // --------------------------
//    match /admin/{docId} {
//   allow read, write: if request.auth != null
//     && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
// }

//     match /analytics/{docId} {
//       allow read, write: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
//     }

//     match /manage-users/{docId} {
//       allow read, write: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
//     }
//   }
// }


// rules_version = '2';

// service cloud.firestore {
//   match /databases/{database}/documents {

//     // --------------------------
//     // USERS COLLECTION
//     // --------------------------
//     match /users/{userId} {
//       allow create: if request.auth != null && request.auth.uid == userId;
//       allow read: if request.auth != null; // added for leaderboard
//       allow update, delete: if request.auth != null && request.auth.uid == userId;
//     }

//     // --------------------------
//     // VENDORS COLLECTION
//     // --------------------------
//     match /vendors/{vendorId} {
//       allow read: if true;
//       allow create, update, delete: if request.auth != null
//         && request.auth.uid == vendorId
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor";
//     }

//     // --------------------------
//     // PRODUCTS COLLECTION
//     // --------------------------
//     match /products/{productId} {
//       allow read: if true;
//       allow create: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor"
//         && request.resource.data.vendorId == request.auth.uid;
//       allow update, delete: if request.auth != null
//         && resource.data.vendorId == request.auth.uid;
//     }

//     // --------------------------
//     // SALES COLLECTION
//     // --------------------------
//     match /sales/{saleId} {
//       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
//       allow read: if request.auth != null &&
//         (
//           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
//           || resource.data.vendorId == request.auth.uid
//           || resource.data.userId == request.auth.uid
//         );
//       allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
//     }

//     // --------------------------
//     // ADMIN COLLECTIONS
//     // --------------------------
//     match /admin/{docId} {
//       allow read, write: if request.auth != null
//         && exists(/databases/$(database)/documents/admins/$(request.auth.uid));
//     }

//     match /analytics/{docId} {
//       allow read, write: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
//     }

//     match /manage-users/{docId} {
//       allow read, write: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
//     }

//     // --------------------------
//     // CHAT COLLECTION
//     // --------------------------
//     match /chats/{chatId} {
//       allow read, write: if request.auth != null;

//       match /messages/{msgId} {
//         allow read, write: if request.auth != null;
//       }
//     }

//     // --------------------------
//     // BADGES COLLECTION
//     // --------------------------
//     match /badges/{badgeId} {
//       allow read: if request.auth != null;
//       allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
//     }
    
//     match /orders/{orderId} {
//       allow create: if request.auth != null
//         && request.resource.data.userId == request.auth.uid;

//       allow read: if request.auth != null
//         && resource.data.userId == request.auth.uid;  // user can read own orders
//     }

//     // --------------------------
//     // LEADERBOARD (users points)
//     // --------------------------
//     // Already handled by USERS read rule above
//     // Any logged-in user can read points for leaderboard
//   }
// }



// rules_version = '2';

// service cloud.firestore {
//   match /databases/{database}/documents {

//     // --------------------------
//     // USERS COLLECTION
//     // --------------------------
//     match /users/{userId} {
//       allow create: if request.auth != null && request.auth.uid == userId;
//       allow read: if request.auth != null; // leaderboard support
//       allow update, delete: if request.auth != null && request.auth.uid == userId;

//       // --------------------------
//       // WISHLIST SUBCOLLECTION
//       // --------------------------
//       match /wishlist/{productId} {
//         allow read, write: if request.auth != null && request.auth.uid == userId;
//       }

//       // --------------------------
//       // NOTIFICATIONS SUBCOLLECTION
//       // --------------------------
//       match /notifications/{notifId} {
//         allow read, update, delete: if request.auth != null && request.auth.uid == userId;
//         allow create: if request.auth != null;
//       }
//     }

//     // --------------------------
//     // VENDORS COLLECTION
//     // --------------------------
//     match /vendors/{vendorId} {
//       allow read: if true;
//       allow create, update, delete: if request.auth != null
//         && request.auth.uid == vendorId
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor";
//     }

//     // --------------------------
//     // PRODUCTS COLLECTION
//     // --------------------------
//     match /products/{productId} {
//       allow read: if true;
//       allow create: if request.auth != null
//         && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor"
//         && request.resource.data.vendorId == request.auth.uid;
//       allow update, delete: if request.auth != null
//         && resource.data.vendorId == request.auth.uid;
//     }

//     // --------------------------
//     // SALES
//     // --------------------------
//     match /sales/{saleId} {
//       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
//       allow read: if request.auth != null &&
//         (
//           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
//           || resource.data.vendorId == request.auth.uid
//           || resource.data.userId == request.auth.uid
//         );
//       allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
//     }

//     // --------------------------
//     // CHATS
//     // --------------------------
//     match /chats/{chatId} {
//       allow read, write: if request.auth != null;

//       match /messages/{msgId} {
//         allow read, write: if request.auth != null;
//       }
//     }

//     // --------------------------
//     // BADGES
//     // --------------------------
//     match /badges/{badgeId} {
//       allow read: if request.auth != null;
//       allow write: if request.auth != null && request.resource.data.userId == request.auth.uid;
//     }

//     // --------------------------
//     // ORDERS
//     // --------------------------
//     match /orders/{orderId} {
//       allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
//       allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
//     }
//   }
// }


rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================
    // USERS COLLECTION
    // =========================
    match /users/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read: if request.auth != null; // supports leaderboard
      allow update, delete: if request.auth != null && request.auth.uid == userId;

      // ----- WISHLIST -----
      match /wishlist/{productId} {
        allow get, list, write: if request.auth != null && request.auth.uid == userId;
      }

      // ----- NOTIFICATIONS -----
      match /notifications/{notifId} {
        allow get, list, update, delete: if request.auth != null && request.auth.uid == userId;
        allow create: if request.auth != null;
      }

      // ----- BADGES -----
      match /badges/{badgeId} {
        allow get, list, write: if request.auth != null && request.auth.uid == userId;
      }

      // ----- REWARDS (if exists) -----
      match /rewards/{rewardId} {
        allow get, list, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // =========================
    // VENDORS COLLECTION
    // =========================
    match /vendors/{vendorId} {
      allow read: if true;
      allow create, update, delete: if request.auth != null
        && request.auth.uid == vendorId
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor";
    }

    // =========================
    // PRODUCTS COLLECTION
    // =========================
    match /products/{productId} {
      allow read: if true;
      allow create: if request.auth != null
        && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "vendor"
        && request.resource.data.vendorId == request.auth.uid;
      allow update, delete: if request.auth != null
        && resource.data.vendorId == request.auth.uid;
    }

    // =========================
    // SALES COLLECTION
    // =========================
    match /sales/{saleId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read: if request.auth != null &&
        (
          get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin"
          || resource.data.vendorId == request.auth.uid
          || resource.data.userId == request.auth.uid
        );
      allow update, delete: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // =========================
    // CHAT SYSTEM
    // =========================
    match /chats/{chatId} {
      allow read, write: if request.auth != null;

      match /messages/{msgId} {
        allow read, write: if request.auth != null;
      }
    }

    // =========================
    // ORDER SYSTEM
    // =========================
    match /orders/{orderId} {
      allow create: if request.auth != null && request.resource.data.userId == request.auth.uid;
      allow read, update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}

